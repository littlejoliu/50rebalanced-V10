<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>50% æ­£2 ç­–ç•¥æ¨¡æ“¬å™¨ (V8.0 é€æ˜æ±ºç­–ç‰ˆ)</title>
    <style>
        /* æ¨£å¼è¨­å®š */
        body { font-family: "Microsoft JhengHei", -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; background-color: #f0f2f5; color: #333; }
        .container { max-width: 600px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 25px; }
        
        .input-group { margin-bottom: 18px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; background-color: #fff; }
        
        /* é€£çµæŒ‰éˆ•å®¹å™¨ */
        .flex-row { display: flex; align-items: flex-end; gap: 10px; }
        .flex-grow { flex-grow: 1; }
        .link-btn { background-color: #17a2b8; color: white; border: none; padding: 12px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; height: 45px; font-weight: bold; }
        .link-btn:hover { background-color: #138496; }

        /* åŸ·è¡ŒæŒ‰éˆ• */
        button.execute-button { background-color: #007bff; color: white; width: 100%; padding: 14px; border: none; border-radius: 5px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: 0.2s; }
        button.execute-button:hover { background-color: #0056b3; transform: translateY(-1px); }
        
        /* çµæœå€å¡Š */
        .result-box { margin-top: 25px; padding: 20px; background-color: #e9ecef; border-radius: 8px; border-left: 6px solid #007bff; display: none; }
        .result-item { margin-bottom: 12px; font-size: 16px; display: flex; justify-content: space-between; border-bottom: 1px solid #dcdcdc; padding-bottom: 8px; }
        .debug-info { font-size: 14px; color: #666; background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px dashed #ccc; }
        
        /* é¡è‰²æ¨™è¨˜ */
        .highlight-green { color: #28a745; font-weight: bold; }
        .highlight-red { color: #dc3545; font-weight: bold; }
        .highlight-blue { color: #007bff; font-weight: bold; }
        .error-msg { color: #dc3545; text-align: center; display: none; margin-top: 10px; font-weight: bold; background-color: #ffe6e6; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ“ˆ 50% æ­£2 ç­–ç•¥æ¨¡æ“¬å™¨</h2>
    
    <div class="input-group">
        <label>ğŸ’° ç›®å‰ç¾é‡‘é¤˜é¡ (å…ƒ)</label>
        <input type="number" id="cashInput" placeholder="è«‹è¼¸å…¥ç¾é‡‘é‡‘é¡">
    </div>

    <div class="input-group">
        <label>ğŸ“ˆ 00631L ç¾æœ‰å¸‚å€¼ (å…ƒ)</label>
        <input type="number" id="stockInput" placeholder="è«‹è¼¸å…¥è‚¡ç¥¨å¸‚å€¼">
    </div>

    <div class="input-group flex-row">
        <div class="flex-grow">
            <label>ğŸš¦ æ™¯æ°£ç‡ˆè™Ÿ</label>
            <select id="macroInput">
                <option value="ç¶ ç‡ˆ" selected>ç¶ ç‡ˆ (ç©©å®š)</option>
                <option value="è—ç‡ˆ">è—ç‡ˆ (ä½è¿·)</option>
                <option value="é»ƒè—ç‡ˆ">é»ƒè—ç‡ˆ (è½‰å‘)</option>
                <option value="é»ƒç´…ç‡ˆ">é»ƒç´…ç‡ˆ (è½‰å‘)</option>
                <option value="ç´…ç‡ˆ">ç´…ç‡ˆ (éç†±)</option>
            </select>
        </div>
        <button class="link-btn" onclick="window.open('https://index.ndc.gov.tw/n/zh_tw', '_blank')">ğŸ” æŸ¥ç‡ˆè™Ÿ</button>
    </div>
    
    <div class="input-group flex-row">
        <div class="flex-grow">
            <label>ğŸ“Š VIX æŒ‡æ•¸</label>
            <input type="number" id="vixInput" placeholder="è¼¸å…¥æ•¸å€¼" value="15">
        </div>
        <button class="link-btn" onclick="window.open('https://finance.yahoo.com/quote/%5EVIX', '_blank')">ğŸ” æŸ¥ VIX</button>
    </div>
    
    <div class="input-group">
        <label>ğŸ—“ï¸ æ˜¯å¦ç‚ºå­£åº¦æª¢æŸ¥æ—¥?</label>
        <select id="quarterInput">
            <option value="false" selected>å¦</option>
            <option value="true">æ˜¯</option>
        </select>
    </div>

    <button class="execute-button" onclick="runStrategy()">åŸ·è¡Œç­–ç•¥åˆ¤è®€</button>
    <div id="errorMsg" class="error-msg">âš ï¸ è«‹è¼¸å…¥é‡‘é¡æ‰èƒ½è¨ˆç®—ï¼</div>

    <div id="resultBox" class="result-box">
        <div class="debug-info">
            <div>ğŸ” <strong>åµæ¸¬æ•¸æ“šï¼š</strong> <span id="debugStatus"></span></div>
            <div>ğŸ¯ <strong>ç›®æ¨™æ¯”ä¾‹ï¼š</strong> <span id="debugTarget"></span></div>
            <div>ğŸ›¡ï¸ <strong>å®‰å…¨å€é–“ï¼š</strong> <span id="debugRange"></span> (åœ¨æ­¤ç¯„åœä¸å‹•ä½œ)</div>
        </div>

        <div class="result-item">
            <span>ğŸ“Š ç¸½è³‡ç”¢</span>
            <span id="resTotal" style="font-weight:bold; color:#0056b3;"></span>
        </div>
        <div class="result-item">
            <span>ğŸ“‰ å¯¦éš›æŒå€‰æ¯”ä¾‹</span>
            <span id="resActual"></span>
        </div>
        <div class="result-item">
            <span>ğŸ‘‰ å»ºè­°æ“ä½œ</span>
            <span id="resAction" style="font-size:1.1em;"></span>
        </div>
        <div class="result-item" style="border:none; margin-top:10px;">
            <span>ğŸ’° äº¤æ˜“é‡‘é¡</span>
            <span id="resAmount" style="font-size:1.2em;"></span>
        </div>
    </div>
</div>

<script>
    // ç­–ç•¥åƒæ•¸
    const P_DEFAULT = 0.50; 
    const THRESHOLD_EMERGENCY = 0.15; // 15% (ç·Šæ€¥)
    const THRESHOLD_QUARTER = 0.10;   // 10% (å­£åº¦)

    function runStrategy() {
        // 1. æŠ“å–è¼¸å…¥å€¼
        let cashStr = document.getElementById('cashInput').value;
        let stockStr = document.getElementById('stockInput').value;
        let light = document.getElementById('macroInput').value;
        let vixStr = document.getElementById('vixInput').value;
        let isQuarter = document.getElementById('quarterInput').value === 'true';

        // 2. é˜²å‘†æª¢æŸ¥
        if (cashStr === '' || stockStr === '') {
            document.getElementById('errorMsg').style.display = 'block';
            document.getElementById('resultBox').style.display = 'none';
            return;
        }
        document.getElementById('errorMsg').style.display = 'none';
        document.getElementById('resultBox').style.display = 'block';

        // 3. æ•¸å€¼è½‰æ›
        let cash = parseFloat(cashStr);
        let stock = parseFloat(stockStr);
        let vix = parseFloat(vixStr) || 15; // è‹¥æ²’å¡«ï¼Œé è¨­15
        let total = cash + stock;

        // 4. æ±ºå®šç›®æ¨™æ¯”ä¾‹ P
        let targetP = P_DEFAULT;
        let logicText = "ä¸­æ€§ç­–ç•¥ (50%)";

        // *** é—œéµåˆ¤æ–·é‚è¼¯ ***
        if (light === 'ç´…ç‡ˆ' && vix <= 12) {
            targetP = 0.40;
            logicText = "ğŸ”´ è²ªå©ªé™é€Ÿ (40%)";
        } else if (light === 'è—ç‡ˆ' && vix >= 30) {
            targetP = 0.60;
            logicText = "ğŸ”µ ææ…ŒåŠ é€Ÿ (60%)";
        }

        // 5. è¨ˆç®—æ•¸æ“š
        let targetStockVal = total * targetP;
        let actualRatio = stock / total;
        let action = "ç¶­æŒä¸è®Š";
        let tradeVal = 0;
        let actionClass = "highlight-blue";

        // 6. è¨ˆç®—é–€æª» (ç‚ºäº†é™¤éŒ¯ï¼Œé€™è£¡å…ˆç®—å‡ºä¾†é¡¯ç¤º)
        let upperE = targetP * (1 + THRESHOLD_EMERGENCY);
        let lowerE = targetP * (1 - THRESHOLD_EMERGENCY);
        let upperQ = targetP * (1 + THRESHOLD_QUARTER);
        let lowerQ = targetP * (1 - THRESHOLD_QUARTER);
        
        // æ±ºå®šç•¶ä¸‹ç”Ÿæ•ˆçš„é–€æª»ç¯„åœ (é¡¯ç¤ºç”¨)
        let activeLower = lowerE;
        let activeUpper = upperE;
        if (isQuarter) {
             // å¦‚æœæ˜¯å­£åº¦ï¼Œæª¢æŸ¥ç¯„åœè®Šçª„
             activeLower = lowerQ;
             activeUpper = upperQ;
        }

        // 7. åŸ·è¡Œåˆ¤æ–· (é‚è¼¯æ ¸å¿ƒ)
        if (actualRatio >= upperE) {
            action = "ç·Šæ€¥è³£å‡º (é«˜æ–¼ " + (upperE*100).toFixed(1) + "%)";
            tradeVal = stock - targetStockVal; // å›åˆ°ç›®æ¨™
            actionClass = "highlight-red";
        } else if (actualRatio <= lowerE) {
            action = "ç·Šæ€¥è²·å…¥ (ä½æ–¼ " + (lowerE*100).toFixed(1) + "%)";
            tradeVal = targetStockVal - stock; // å›åˆ°ç›®æ¨™
            actionClass = "highlight-green";
        } else if (isQuarter) {
            if (actualRatio >= upperQ) {
                action = "å­£åº¦è³£å‡º";
                tradeVal = stock - targetStockVal;
                actionClass = "highlight-red";
            } else if (actualRatio <= lowerQ) {
                action = "å­£åº¦è²·å…¥";
                tradeVal = targetStockVal - stock;
                actionClass = "highlight-green";
            }
        }

        // 8. æ›´æ–°ä»‹é¢
        document.getElementById('resTotal').innerText = "NT$ " + Math.round(total).toLocaleString();
        document.getElementById('resActual').innerText = (actualRatio * 100).toFixed(2) + "%";
        
        let actSpan = document.getElementById('resAction');
        actSpan.innerText = action;
        actSpan.className = actionClass;

        if (tradeVal > 0) {
            document.getElementById('resAmount').innerText = "NT$ " + Math.round(tradeVal).toLocaleString();
            document.getElementById('resAmount').className = actionClass;
        } else {
            document.getElementById('resAmount').innerText = "NT$ 0";
            document.getElementById('resAmount').className = "";
        }

        // 9. æ›´æ–°é™¤éŒ¯å„€è¡¨æ¿ (Debug Info)
        document.getElementById('debugStatus').innerText = `${light} + VIX ${vix}`;
        document.getElementById('debugTarget').innerText = logicText;
        document.getElementById('debugRange').innerText = `${(activeLower*100).toFixed(1)}% ~ ${(activeUpper*100).toFixed(1)}%`;
    }
</script>

</body>
</html>